<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal de Documentos</title>

  <style>
    :root{
      --bg:#0b1220; --card:#121c2f; --muted:#9fb0d0; --txt:#e8efff;
      --accent:#4da3ff; --line: rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#070c16,var(--bg)); color:var(--txt)
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,18,32,.86); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line)
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;display:grid;place-items:center;
      background:rgba(77,163,255,.14);border:1px solid rgba(77,163,255,.22);font-size:18px
    }
    h1{margin:0;font-size:16px}
    .sub{margin:0;color:var(--muted);font-size:12px}

    .controls{display:flex;gap:10px;align-items:center;padding:0 16px 14px;flex-wrap:wrap}
    input, select{
      appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--txt);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    input{flex:1;min-width:220px}

    .tabs{display:flex;gap:8px;padding:0 16px 14px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      color:var(--txt); padding:10px 12px; border-radius:14px;
      cursor:pointer; font-weight:650; font-size:13px
    }
    .tab.active{background:rgba(77,163,255,.18); border-color:rgba(77,163,255,.35)}

    /* √°rea rol√°vel (estilo app) */
    main.wrap{height:calc(100vh - 170px); overflow:auto; padding-top:12px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}

    .card{
      grid-column:span 12; background:rgba(18,28,47,.92);
      border:1px solid var(--line); border-radius:18px;
      padding:14px; display:flex; gap:12px; align-items:flex-start
    }
    @media (min-width:760px){ .card{grid-column:span 6} }
    @media (min-width:1050px){ .card{grid-column:span 4} }

    .wide{grid-column:span 12}

    .icon{
      width:42px;height:42px;border-radius:14px;display:grid;place-items:center;
      background:rgba(77,163,255,.14);border:1px solid rgba(77,163,255,.22);
      font-size:18px;flex:0 0 auto
    }
    .meta{flex:1;min-width:0}
    .title{
      margin:0 0 4px;font-weight:750;
      white-space:normal; overflow:visible; text-overflow:unset;
      line-height:1.2
    }
    .desc{margin:0;color:var(--muted);font-size:13px;line-height:1.3}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
    .chip{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}

    .btn{
      display:inline-flex;gap:8px;align-items:center;text-decoration:none;
      padding:10px 12px;border-radius:14px;
      background:rgba(77,163,255,.18);
      border:1px solid rgba(77,163,255,.35); color:var(--txt); margin-top:10px
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      margin-left:8px
    }
    .warn{color:#ffd28a}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    footer{
      padding:12px 16px;color:var(--muted);
      font-size:12px;text-align:center;border-top:1px solid var(--line)
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">üìÅ</div>
      <div>
        <h1>Portal de Documentos</h1>
        <p class="sub">Lista autom√°tica (inclui subpastas) ‚Ä¢ GitHub Pages</p>
      </div>
    </div>
    <div style="color:var(--muted);font-size:12px" id="repoTag"></div>
  </div>

  <div class="controls">
    <input id="q" placeholder="Buscar por nome..." />
    <select id="ext">
      <option value="pdf">Mostrar: PDFs</option>
      <option value="all">Mostrar: Tudo</option>
    </select>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="ordens">Ordens de Servi√ßo</button>
    <button class="tab" data-tab="boletins">Boletins</button>
    <button class="tab" data-tab="contatos">Contatos</button>
  </div>
</header>

<main class="wrap">
  <div id="grid" class="grid"></div>
</main>

<footer>
  Para adicionar arquivos: fa√ßa upload nas pastas do reposit√≥rio. O site atualiza sozinho.
</footer>

<script>
/** ====== CONFIG DO SEU REPO ====== */
const OWNER  = "danielzavalhia-commits";
const REPO   = "dani2";
const BRANCH = "main";

/**
 * Pastas ‚Äúraiz‚Äù de cada se√ß√£o.
 * Tudo dentro (inclusive subpastas) aparece.
 */
const SECTIONS = {
  ordens: [
    { label: "Ordens de Servi√ßo", root: "ordens_servico", icon: "üß∞" }
  ],
  boletins: [
    { label: "Boletins T√©cnicos", root: "boletins/tecnicos", icon: "üõ†Ô∏è" },
    { label: "Boletins M√£o de Obra", root: "boletins/mao_de_obra", icon: "üë∑" }
  ],
  contatos: [
    { label: "Contatos", root: "contatos", icon: "üë•" }
  ]
};

/** ====== UI ====== */
const grid = document.getElementById("grid");
const tabs = [...document.querySelectorAll(".tab")];
const q = document.getElementById("q");
const ext = document.getElementById("ext");
document.getElementById("repoTag").textContent = `${OWNER}/${REPO}`;

/** ====== Helpers ====== */
function prettifyPath(path){
  const name = path.split("/").pop() || path;
  const base = name.replace(/\.[^/.]+$/, "");
  return base
    .replace(/[_-]+/g," ")
    .replace(/\s+/g," ")
    .trim()
    .replace(/\b\w/g, c=>c.toUpperCase());
}
function isPdf(path){ return path.toLowerCase().endsWith(".pdf"); }
function startsWithFolder(filePath, folderRoot){
  const a = filePath.replace(/^\/+/,"");
  const b = folderRoot.replace(/^\/+/,"").replace(/\/+$/,"");
  return a === b || a.startsWith(b + "/");
}
function pageHrefFor(filePath){
  // abre via GitHub Pages (mais chance de abrir inline)
  // exemplo: https://.../dani2/boletins/tecnicos/arquivo.pdf
  return new URL(filePath.replace(/^\/+/,""), window.location.href).href;
}
function githubFileUrl(filePath){
  return `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${filePath.replace(/^\/+/,"")}`;
}

/** ====== Cache da √°rvore do repo ====== */
let TREE = null;

async function getBranchSha(){
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/branches/${BRANCH}`;
  const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" }});
  if(!res.ok) throw new Error(`N√£o consegui ler a branch ${BRANCH} (HTTP ${res.status}).`);
  const data = await res.json();
  return data?.commit?.sha;
}

async function getRepoTree(){
  if(TREE) return TREE;

  const sha = await getBranchSha();
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${sha}?recursive=1`;
  const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" }});
  if(!res.ok) throw new Error(`N√£o consegui listar os arquivos (HTTP ${res.status}).`);
  const data = await res.json();

  // data.tree -> itens com { path, type: "blob" | "tree" }
  TREE = (data.tree || []).filter(x => x.type === "blob").map(x => x.path);
  return TREE;
}

/** ====== Render ====== */
let activeTab = "ordens";

function headerCard(title, subtitle, chips=[]){
  return `
    <div class="card wide">
      <div class="icon">üìÇ</div>
      <div class="meta">
        <p class="title">${title}</p>
        <p class="desc">${subtitle}</p>
        <div class="chips">${chips.map(c=>`<span class="chip">${c}</span>`).join("")}</div>
      </div>
    </div>
  `;
}

function itemCard(icon, filePath){
  const title = prettifyPath(filePath);
  const href = pageHrefFor(filePath);
  const gh  = githubFileUrl(filePath);
  const chips = [
    isPdf(filePath) ? "PDF" : "Arquivo",
    filePath
  ];
  return `
    <div class="card">
      <div class="icon">üìÑ</div>
      <div class="meta">
        <p class="title" title="${title}">${title}</p>
        <p class="desc">${isPdf(filePath) ? "PDF" : "Arquivo"}</p>
        <div class="chips">${chips.map(c=>`<span class="chip">${c}</span>`).join("")}</div>
        <a class="btn" href="${href}" target="_blank" rel="noopener">Abrir ‚Üí</a>
        <a class="btn secondary" href="${gh}" target="_blank" rel="noopener">Ver no GitHub</a>
      </div>
    </div>
  `;
}

function warnCard(msg){
  return `
    <div class="card wide">
      <div class="meta">
        <p class="title warn">‚ö†Ô∏è Aviso</p>
        <p class="desc">${msg}</p>
      </div>
    </div>
  `;
}

async function render(){
  grid.innerHTML = headerCard(
    activeTab === "boletins" ? "Boletins" :
    activeTab === "ordens" ? "Ordens de Servi√ßo" : "Contatos",
    "Listando automaticamente todos os arquivos (inclusive dentro de subpastas).",
    [
      `Filtro: ${ext.value === "pdf" ? "PDFs" : "Tudo"}`,
      q.value ? `Busca: "${q.value}"` : "Busca: (vazia)"
    ]
  );

  let allFiles;
  try{
    allFiles = await getRepoTree();
  }catch(e){
    grid.innerHTML += warnCard(e.message || String(e));
    return;
  }

  const query = (q.value || "").trim().toLowerCase();
  const showOnlyPdf = (ext.value === "pdf");

  for(const section of SECTIONS[activeTab]){
    const root = section.root.replace(/\/+$/,"");
    let files = allFiles.filter(p => startsWithFolder(p, root));

    if(showOnlyPdf) files = files.filter(isPdf);

    if(query){
      files = files.filter(p => p.toLowerCase().includes(query));
    }

    files.sort((a,b)=>a.localeCompare(b,"pt-BR"));

    grid.innerHTML += headerCard(
      section.label,
      `Pasta base: <code>/${root}</code> ‚Ä¢ Itens encontrados: <b>${files.length}</b>`,
      [root]
    );

    if(files.length === 0){
      grid.innerHTML += `
        <div class="card wide">
          <div class="meta">
            <p class="title">Nenhum arquivo</p>
            <p class="desc">Envie arquivos para <code>/${root}</code> (pode ser dentro de subpastas tamb√©m).</p>
          </div>
        </div>
      `;
      continue;
    }

    for(const p of files){
      grid.innerHTML += itemCard(section.icon, p);
    }
  }

  // Se ainda estiver abrindo ‚ÄúSalvar como‚Äù:
  // isso depende do navegador/Windows/plug-in de PDF. Com o link via Pages, normalmente abre inline.
}

tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeTab = t.dataset.tab;
    render();
  });
});

q.addEventListener("input", ()=>render());
ext.addEventListener("change", ()=>render());

render();
</script>
</body>
</html>
